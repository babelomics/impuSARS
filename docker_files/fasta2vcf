#!/bin/bash -l

# Input arguments
function parseArgs(){

	arg=$1
	while [[ "$arg" != "" ]]
	do
		case "$1" in
			"--infasta")
			 shift
			 infasta=$1
			 ;;
                        "--outvcf")
                         shift
                         outvcf=$1
                         ;;
			*)
			 echo 'Unknown argument '$1
			 shift
		esac
		shift
		arg=$1
	done
}


parseArgs $@

reference="/Minimac4/reference/GISAID_COVID_REFERENCE.v1.0.fasta"
refN="/Minimac4/reference/REFERENCE_N.fa"
headers="/Minimac4/reference/VCF_headers.txt"

cat $reference $infasta > /tmp/joined.fa
muscle -in /tmp/joined.fa -out /tmp/aligned.fa

# Check if gaps in reference and fix
gaps=`head -500 /tmp/aligned.fa | grep "-" | tr -d '\r\n'`
refline=1
final=500
if [[ "$gaps" == *"-"* ]]; then
   mv /tmp/aligned.fa /tmp/prealigned.fa
   fixFASTA.py --fasta /tmp/prealigned.fa --output /tmp/aligned.fa
   refline=`grep -n ">X" /tmp/aligned.fa | cut -f1 -d':'`
   final=$(( refline + 1 ))
fi

# Removing reference from alignment and masking
sed --re "${refline},${final}d" /tmp/aligned.fa > /tmp/aligned_sequence.fa
sed -i 's/-/N/g' /tmp/aligned_sequence.fa

# Convert to VCF with reference to Ns
FastaToVCF.py -r $refN /tmp/aligned_sequence.fa /tmp/aligned.vcf
cat $headers /tmp/aligned.vcf | bgzip > /tmp/aligned.vcf.gz
tabix /tmp/aligned.vcf.gz

# Fix reference to real reference once Ns have been discarded
bcftools norm --check-ref s -f $reference /tmp/aligned.vcf.gz \
     -Oz -o $outvcf
tabix $outvcf
